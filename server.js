// === –ò–º–ø–æ—Ä—Ç—ã –∏ –±–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ===
import express from "express";
import fetch from "node-fetch";
import dotenv from "dotenv";
import querystring from "querystring";

dotenv.config();

const app = express();
const PORT = process.env.PORT || 3000;

// === Fallback –¥–ª—è text/plain (–¥–æ –¥—Ä—É–≥–∏—Ö –ø–∞—Ä—Å–µ—Ä–æ–≤) ===
app.use((req, res, next) => {
  const contentType = req.headers["content-type"] || "";
  if (contentType.includes("text/plain")) {
    let data = "";
    req.on("data", chunk => {
      data += chunk.toString();
    });
    req.on("end", () => {
      try {
        // –ü—Ä–æ–±—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ JSON
        req.body = JSON.parse(data);
        console.log("üìù text/plain –æ–±—Ä–∞–±–æ—Ç–∞–Ω –∫–∞–∫ JSON");
      } catch (e) {
        // –ï—Å–ª–∏ –Ω–µ JSON, –ø–∞—Ä—Å–∏–º –∫–∞–∫ URL-encoded
        req.body = querystring.parse(data);
        console.log("üìù text/plain –æ–±—Ä–∞–±–æ—Ç–∞–Ω –∫–∞–∫ URL-encoded");
      }
      next();
    });
  } else {
    next();
  }
});

// === Middleware –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞ ===
app.use(express.json({ limit: "10mb" }));
app.use(express.urlencoded({ extended: true, limit: "10mb" }));

// === CORS ===
app.use((req, res, next) => {
  res.header("Access-Control-Allow-Origin", "*");
  res.header("Access-Control-Allow-Methods", "GET, POST, OPTIONS");
  res.header("Access-Control-Allow-Headers", "Content-Type, Authorization");
  if (req.method === "OPTIONS") return res.sendStatus(200);
  next();
});

// === –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ===
app.use((req, res, next) => {
  console.log("\n=== üì® –ó–ê–ü–†–û–° –û–¢ TILDA ===");
  console.log("‚è∞", new Date().toISOString());
  console.log("‚û°Ô∏è", req.method, req.url);
  console.log("üìã Content-Type:", req.headers["content-type"] || "–Ω–µ —É–∫–∞–∑–∞–Ω");
  console.log("üì¶ BODY (raw):", JSON.stringify(req.body, null, 2));
  console.log("========================\n");
  next();
});

// === –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä –¥–∞–Ω–Ω—ã—Ö –∏–∑ Tilda ===
const parseTildaData = (body) => {
  const result = {};
  
  if (!body || typeof body !== 'object') {
    console.warn("‚ö†Ô∏è body –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ –æ–±—ä–µ–∫—Ç:", body);
    return result;
  }
  
  // –§–æ—Ä–º–∞—Ç Tilda: fields[0][name]=city&fields[0][value]=Paris
  // Express —Å extended:true –º–æ–∂–µ—Ç –ø–∞—Ä—Å–∏—Ç—å —ç—Ç–æ –ø–æ-—Ä–∞–∑–Ω–æ–º—É:
  // 1. –ö–∞–∫ –ø–ª–æ—Å–∫–∏–π –æ–±—ä–µ–∫—Ç: { "fields[0][name]": "city", "fields[0][value]": "Paris" }
  // 2. –ö–∞–∫ –≤–ª–æ–∂–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç: { fields: [{ name: "city", value: "Paris" }] }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–ª–æ—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç —Å –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–º–∏ —Å–∫–æ–±–∫–∞–º–∏
  const fieldKeys = Object.keys(body).filter(key => 
    typeof key === 'string' && key.startsWith("fields[")
  );
  
  if (fieldKeys.length > 0) {
    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ–ª—è –ø–æ –∏–Ω–¥–µ–∫—Å—É
    const fieldsMap = {};
    for (const key of fieldKeys) {
      const match = key.match(/fields\[(\d+)\]\[(name|value)\]/);
      if (match) {
        const index = match[1];
        const type = match[2];
        if (!fieldsMap[index]) {
          fieldsMap[index] = {};
        }
        fieldsMap[index][type] = body[key];
      }
    }
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –æ–±—ä–µ–∫—Ç result
    for (const index in fieldsMap) {
      const field = fieldsMap[index];
      if (field.name && field.value !== undefined && field.value !== null) {
        result[field.name] = String(field.value).trim();
      }
    }
    
    console.log("üîç –ü–∞—Ä—Å–∏–Ω–≥ Tilda —Ñ–æ—Ä–º–∞—Ç–∞ (–ø–ª–æ—Å–∫–∏–π):", { 
      fieldKeys: fieldKeys.length, 
      parsed: result,
      sampleKeys: fieldKeys.slice(0, 3)
    });
  } 
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–ª–æ–∂–µ–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: { fields: { "0": { name: "...", value: "..." } } }
  else if (body.fields) {
    if (Array.isArray(body.fields)) {
      // –§–æ—Ä–º–∞—Ç: { fields: [{ name: "...", value: "..." }] }
      for (const field of body.fields) {
        if (field && field.name && field.value !== undefined && field.value !== null) {
          result[field.name] = String(field.value).trim();
        }
      }
      console.log("üîç –ü–∞—Ä—Å–∏–Ω–≥ –º–∞—Å—Å–∏–≤–∞ fields:", result);
    } else if (typeof body.fields === 'object') {
      // –§–æ—Ä–º–∞—Ç: { fields: { "0": { name: "...", value: "..." } } }
      for (const index in body.fields) {
        const field = body.fields[index];
        if (field && field.name && field.value !== undefined && field.value !== null) {
          result[field.name] = String(field.value).trim();
        }
      }
      console.log("üîç –ü–∞—Ä—Å–∏–Ω–≥ –æ–±—ä–µ–∫—Ç–∞ fields:", result);
    }
  } 
  // –ü—Ä—è–º–æ–π —Ñ–æ—Ä–º–∞—Ç: { city: "Paris", email: "..." }
  else {
    // –ò—Å–∫–ª—é—á–∞–µ–º —Å–ª—É–∂–µ–±–Ω—ã–µ –ø–æ–ª—è
    const ignoreKeys = ['pageid', 'formid', 'pageurl', 'formname', 't', 'referer'];
    for (const key in body) {
      if (!ignoreKeys.includes(key) && body[key] !== undefined && body[key] !== null) {
        result[key] = String(body[key]).trim();
      }
    }
    console.log("üîç –ü–∞—Ä—Å–∏–Ω–≥ –ø—Ä—è–º–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞:", result);
  }
  
  return result;
};

// === –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–æ–ª—è —Å –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ –∏–º–µ–Ω–∞–º–∏ ===
const extractField = (data, names) => {
  if (!data || typeof data !== 'object') return null;
  
  // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
  for (const name of names) {
    const value = data[name];
    const normalized = normalizeText(value);
    if (normalized) return normalized;
  }
  
  // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –ø—Ä–æ–±—É–µ–º –ø–æ–∏—Å–∫ –±–µ–∑ —É—á–µ—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞ –∏ –ø—Ä–æ–±–µ–ª–æ–≤
  const dataKeys = Object.keys(data);
  const normalizedDataKeys = dataKeys.map(k => k.toLowerCase().replace(/\s+/g, '_').replace(/-/g, '_'));
  
  for (const name of names) {
    const normalizedName = name.toLowerCase().replace(/\s+/g, '_').replace(/-/g, '_');
    const index = normalizedDataKeys.indexOf(normalizedName);
    if (index !== -1) {
      const value = data[dataKeys[index]];
      const normalized = normalizeText(value);
      if (normalized) return normalized;
    }
  }
  
  return null;
};

// === –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π ===
const normalizeText = (value) => {
  if (value === undefined || value === null) return null;
  const text = String(value).trim();
  if (!text) return null;
  const lowered = text.toLowerCase();
  if (["null", "undefined", "nan"].includes(lowered)) return null;
  return text;
};

// === –†–∞–∑–±–æ—Ä –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ + "–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç" ===
const buildInterests = (rawInterests, customInterest) => {
  const interestsSet = new Set();

  const pushInterest = (val) => {
    const normalized = normalizeText(val);
    if (!normalized) return;
    const lowered = normalized.toLowerCase();
    if (lowered === "—Å–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç" || lowered === "—Å–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç *") return;
    interestsSet.add(normalized);
  };

  const tryParseArray = (value) => {
    if (!value) return false;
    if (Array.isArray(value)) {
      value.forEach(pushInterest);
      return true;
    }
    const text = normalizeText(value);
    if (!text) return false;
    try {
      const parsed = JSON.parse(text);
      if (Array.isArray(parsed)) {
        parsed.forEach(pushInterest);
        return true;
      }
    } catch (e) {
      // ignore parse errors
    }
    return false;
  };

  if (!tryParseArray(rawInterests)) {
    const fallback = normalizeText(rawInterests);
    if (fallback) {
      fallback
        .split(/[,;\n]/)
        .map((item) => item.trim())
        .filter(Boolean)
        .forEach(pushInterest);
    }
  }

  const normalizedCustom = normalizeText(customInterest);
  if (normalizedCustom) {
    interestsSet.add(normalizedCustom);
  }

  return Array.from(interestsSet);
};

// === –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º–ø—Ç–∞ ===
const buildPrompt = (city, start, end, budget, interests, people, comment) => {
  // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
  const cityName = city || "–Ω–µ —É–∫–∞–∑–∞–Ω";
  const startDate = start || "–Ω–µ —É–∫–∞–∑–∞–Ω—ã";
  const endDate = end || "–Ω–µ —É–∫–∞–∑–∞–Ω—ã";
  const budgetLevel = budget || "–Ω–µ —É–∫–∞–∑–∞–Ω";
  const interestsBlock = interests?.length ? interests.join(", ") : "–Ω–µ —É–∫–∞–∑–∞–Ω—ã";
  const peopleCount = people || "1";
  const additionalComment = comment || null;

  return `–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π travel-–∫–æ–Ω—Å—å–µ—Ä–∂ –∫–ª–∞—Å—Å–∞ –ª—é–∫—Å, —Å–æ–∑–¥–∞—é—â–∏–π –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è –ø–æ–¥ –∫–ª—é—á —Å –ø–æ–ª–Ω—ã–º —É—á–µ—Ç–æ–º –≤—Å–µ—Ö –ø–æ–∂–µ–ª–∞–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–∞. 
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–µ –ø—Ä–æ—Å—Ç–æ –æ–ø–∏—Å–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç, –∞ –ø—Ä–æ–¥–∞—Ç—å –º–µ—á—Ç—É –æ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–∏ —Ç–∞–∫, —á—Ç–æ–±—ã –∫–ª–∏–µ–Ω—Ç –∑–∞—Ö–æ—Ç–µ–ª –æ—Ç–ø—Ä–∞–≤–∏—Ç—å—Å—è –≤ –Ω–µ–≥–æ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å. 
–ú–∞—Ä—à—Ä—É—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø—Ä–æ–¥—É–º–∞–Ω –¥–æ –º–µ–ª–æ—á–µ–π –∏ –ø–æ–¥–∞–Ω —Å –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ–º –∏ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ—Å—Ç—å—é, —Å–ª–æ–≤–Ω–æ —ç—Ç–æ —É—Å–ª—É–≥–∞ –ø—Ä–µ–º–∏—É–º-–∫–ª–∞—Å—Å–∞.

–°–æ–∑–¥–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω—ã–π, –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π –∏ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏–π –º–∞—Ä—à—Ä—É—Ç –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è –≤ ${cityName}, —É—á–∏—Ç—ã–≤–∞—è –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–µ—Ç–∞–ª–∏:

üìÖ –î–∞—Ç—ã –ø–æ–µ–∑–¥–∫–∏: ${startDate} ‚Äî ${endDate}
üí∞ –£—Ä–æ–≤–µ–Ω—å –±—é–¥–∂–µ—Ç–∞: ${budgetLevel}
üéØ –ò–Ω—Ç–µ—Ä–µ—Å—ã: ${interestsBlock}
üë• –ü—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤: ${peopleCount}
${additionalComment ? `üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è: ${additionalComment}` : ""}

---

### 1. –û–±—â–µ–µ –æ–ø–∏—Å–∞–Ω–∏–µ ‚úàÔ∏è

–û–ø–∏—à–∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –≥–æ—Ä–æ–¥–∞ –∫–∞–∫ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–Ω—ã–π travel-–±–ª–æ–≥–µ—Ä, –Ω–æ —Å –ø–æ–¥—Ö–æ–¥–æ–º –ª–∏—á–Ω–æ–≥–æ luxury-–∫–æ–Ω—Å—å–µ—Ä–∂–∞. 
–ü–µ—Ä–µ–¥–∞–π —á–µ—Ä–µ–∑ —Å–ª–æ–≤–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –¥—É—Ö –∏ —à–∞—Ä–º –º–µ—Å—Ç–∞. 
–û–±—ä—è—Å–Ω–∏, –ø–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —ç—Ç–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ –∏–Ω—Ç–µ—Ä–µ—Å—ã –∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞, —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–≤ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π ¬´—Ö—É–∫¬ª –≤ –Ω–∞—á–∞–ª–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è. 
–ü–æ–∫–∞–∂–∏, –∫–∞–∫–∏–µ –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è –∂–¥—É—Ç –ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞, –∞–∫—Ü–µ–Ω—Ç–∏—Ä—É—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –æ–ø—ã—Ç–∞. 
–ó–∞–≤–µ—Ä—à–∏ —ç—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –∞–±–∑–∞—Ü–µ–º –≤ —Å—Ç–∏–ª–µ travel-–±—Ä–µ–Ω–¥–∞: ¬´–≠—Ç–æ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ ‚Äî –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–µ–∑–¥–∫–∞, –∞ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è –≤ —ç–º–æ—Ü–∏–∏.¬ª

---

### 2. –ü—Ä–æ–∂–∏–≤–∞–Ω–∏–µ üè®

–ü–æ–¥–±–µ—Ä–∏ 2‚Äì3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –±—é–¥–∂–µ—Ç–æ–º (${budgetLevel}) ‚Äî –Ω–∞–ø—Ä–∏–º–µ—Ä, –±—É—Ç–∏–∫-–æ—Ç–µ–ª—å, —Ä–æ—Å–∫–æ—à–Ω—ã–π –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –æ—Ç–µ–ª—å –∏–ª–∏ –¥–∏–∑–∞–π–Ω–µ—Ä—Å–∫–∏–µ –∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã. 
–î–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ —É–∫–∞–∂–∏ —Ä–∞–π–æ–Ω –≥–æ—Ä–æ–¥–∞, –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –æ–±—ä–µ–∫—Ç –∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—É—é —Ü–µ–Ω—É –∑–∞ –Ω–æ—á—å. 
–î–æ–±–∞–≤—å –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã –∏ –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´–≤–∏–Ω—Ç–∞–∂–Ω—ã–π —à–∞—Ä–º –æ—Å–æ–±–Ω—è–∫–∞ XIX –≤–µ–∫–∞¬ª, ¬´–ø–∞–Ω–æ—Ä–∞–º–Ω—ã–π –≤–∏–¥ –Ω–∞ —Å—Ç–∞—Ä—ã–π –≥–æ—Ä–æ–¥¬ª, ¬´—É–ª—å—Ç—Ä–∞—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∏–Ω–∏–º–∞–ª–∏–∑–º —Å –∞–≤—Ç–æ—Ä—Å–∫–∏–º –¥–∏–∑–∞–π–Ω–æ–º¬ª). 
–î–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –≤–∫–ª—é—á–∏ –∫–Ω–æ–ø–∫—É-–ø—Ä–∏–∑—ã–≤: üëâ –£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ

---

### 3. –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ø–ª–∞–Ω üìÖ

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è –ø—Ä–µ–¥—Å—Ç–∞–≤—å –ø–æ–¥—Ä–æ–±–Ω—ã–π –∏ –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π –≥–∏–¥, —Ä–∞–∑–±–∏—Ç—ã–π –Ω–∞ —É—Ç—Ä–æ, –¥–µ–Ω—å –∏ –≤–µ—á–µ—Ä:

**–£—Ç—Ä–æ ‚òï:** –û–ø–∏—à–∏, –∫–∞–∫ –ª—É—á—à–µ –Ω–∞—á–∞—Ç—å –¥–µ–Ω—å. –ü—Ä–µ–¥–ª–æ–∂–∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–æ–µ –º–µ—Å—Ç–æ –¥–ª—è –∑–∞–≤—Ç—Ä–∞–∫–∞ –∏–ª–∏ —É—Ç—Ä–µ–Ω–Ω–µ–π –ø—Ä–æ–≥—É–ª–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞—Ñ–µ —Å –∞—Ä–æ–º–∞—Ç–Ω—ã–º —Å–≤–µ–∂–∏–º –∫–æ—Ñ–µ –∏ –≤–∏–¥–æ–º –Ω–∞ –æ–∂–∏–≤–∞—é—â–∏–µ —É–ª–∏—Ü—ã, –ø–∞—Ä–∫ –¥–ª—è –ø—Ä–æ–±–µ–∂–∫–∏ –∏–ª–∏ –Ω–∞–±–µ—Ä–µ–∂–Ω—É—é –¥–ª—è —Å–ø–æ–∫–æ–π–Ω–æ–π –ø—Ä–æ–≥—É–ª–∫–∏), —á—Ç–æ–±—ã –∑–∞–¥–∞—Ç—å —Ç–æ–Ω –≤—Å–µ–º—É –¥–Ω—é.

**–î–µ–Ω—å üåá:** –†–∞—Å—Å–∫–∞–∂–∏, —á–µ–º –∑–∞–Ω—è—Ç—å—Å—è –¥–Ω–µ–º. –ü—Ä–µ–¥–ª–æ–∂–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, –∑–Ω–∞–∫–æ–≤—ã–µ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏–ª–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∏–Ω—Ç–µ—Ä–µ—Å–∞–º –∫–ª–∏–µ–Ω—Ç–∞ (${interestsBlock}). 
–û–±—ä—è—Å–Ω–∏, —á—Ç–æ –¥–µ–ª–∞–µ—Ç –∫–∞–∂–¥–æ–µ –º–µ—Å—Ç–æ –æ—Å–æ–±–µ–Ω–Ω—ã–º –∏ –ø–æ—á–µ–º—É –æ–Ω–æ —Å—Ç–æ–∏—Ç –ø–æ—Å–µ—â–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–∫—Ä—ã—Ç–∞—è –≥–∞–ª–µ—Ä–µ—è –∏—Å–∫—É—Å—Å—Ç–≤–∞ –¥–ª—è —Ü–µ–Ω–∏—Ç–µ–ª–µ–π –∏–ª–∏ –≤–∏–Ω–æ–¥–µ–ª—å–Ω—è –∑–∞ –≥–æ—Ä–æ–¥–æ–º –¥–ª—è –≥—É—Ä–º–∞–Ω–æ–≤).

**–í–µ—á–µ—Ä üåÉ:** –û–ø–∏—à–∏ –∏–¥–µ–∞–ª—å–Ω—ã–π –∫–æ–Ω–µ—Ü –¥–Ω—è. –ü–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã, –±–∞—Ä—ã –∏–ª–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –¥–ª—è —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω–æ–≥–æ –≤–µ—á–µ—Ä–∞ –∏–ª–∏ —è—Ä–∫–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –¥–Ω—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, —É–∂–∏–Ω –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ —Å –≤–∏–¥–æ–º –Ω–∞ –∑–∞–∫–∞—Ç, –∫–æ–∫—Ç–µ–π–ª–∏ –Ω–∞ –∫—Ä—ã—à–µ –Ω–µ–±–æ—Å–∫—Ä–µ–±–∞, –≤–µ—á–µ—Ä–Ω–∏–π —Å–ø–µ–∫—Ç–∞–∫–ª—å –∏–ª–∏ –ø—Ä–æ–≥—É–ª–∫–∞ –ø–æ –∏–ª–ª—é–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —É–ª–∏—Ü–∞–º). 
–ü–æ–¥—á–µ—Ä–∫–Ω–∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –∫–∞–∂–¥–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ ‚Äì —Ä–æ–º–∞–Ω—Ç–∏–∫—É –æ–≥–Ω–µ–π –Ω–æ—á–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞, —É—é—Ç –∂–∏–≤–æ–π –º—É–∑—ã–∫–∏ –∏–ª–∏ –∞–∑–∞—Ä—Ç –Ω–æ—á–Ω–æ–π –∂–∏–∑–Ω–∏.

–ö–∞–∂–¥–æ–µ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ —Å–Ω–∞–±–¥–∏ –∫–æ—Ä–æ—Ç–∫–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ–º, –æ–±—ä—è—Å–Ω—è—é—â–∏–º, –ø–æ—á–µ–º—É –µ–≥–æ –Ω–µ–ª—å–∑—è –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å, –¥–µ–ª–∞—è –∞–∫—Ü–µ–Ω—Ç –Ω–∞ —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ—Å—Ç–∏ –∏ –Ω–µ–ø–æ–≤—Ç–æ—Ä–∏–º—ã—Ö —ç–º–æ—Ü–∏—è—Ö –æ—Ç –ø–æ—Å–µ—â–µ–Ω–∏—è. 
–ü–æ—Å–ª–µ –æ–ø–∏—Å–∞–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—Ç–∞ –¥–æ–±–∞–≤–ª—è–π –∫–Ω–æ–ø–∫—É-—Å—Å—ã–ª–∫—É: üëâ –£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –æ –º–µ—Å—Ç–µ

---

### 4. –ú–µ—Å—Ç–Ω–∞—è –∫—É—Ö–Ω—è üçΩÔ∏è

–†–∞—Å—Å–∫–∞–∂–∏ –æ 2‚Äì3 —Ñ–∏—Ä–º–µ–Ω–Ω—ã—Ö –±–ª—é–¥–∞—Ö –∏–ª–∏ –¥–µ–ª–∏–∫–∞—Ç–µ—Å–∞—Ö –º–µ—Å—Ç–Ω–æ–π –∫—É—Ö–Ω–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å—Ç–æ–∏—Ç –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –≤ ${cityName}. 
–ö –∫–∞–∂–¥–æ–º—É –±–ª—é–¥—É –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–π –∑–∞–≤–µ–¥–µ–Ω–∏–µ, –≥–¥–µ –µ–≥–æ –≥–æ—Ç–æ–≤—è—Ç –Ω–∞–∏–ª—É—á—à–∏–º –æ–±—Ä–∞–∑–æ–º. 
–û–ø–∏—à–∏ –∞—Ç–º–æ—Å—Ñ–µ—Ä—É —ç—Ç–∏—Ö –∑–∞–≤–µ–¥–µ–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, ¬´—Å–µ–º–µ–π–Ω–∞—è —Ç–∞–≤–µ—Ä–Ω–∞ —Å –º–Ω–æ–≥–æ–ª–µ—Ç–Ω–µ–π –∏—Å—Ç–æ—Ä–∏–µ–π¬ª, ¬´–±–æ–≥–µ–º–Ω—ã–π —Ä–µ—Å—Ç–æ—Ä–∞–Ω, –≥–¥–µ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –º–µ—Å—Ç–Ω—ã–µ —Ö—É–¥–æ–∂–Ω–∏–∫–∏¬ª, ¬´–æ–∂–∏–≤–ª–µ–Ω–Ω—ã–π —É–ª–∏—á–Ω—ã–π —Ä—ã–Ω–æ–∫ —Å –ª—É—á—à–∏–º —Å—Ç—Ä–∏—Ç—Ñ—É–¥–æ–º¬ª). 
–ü–µ—Ä–µ–¥–∞–π —á–µ—Ä–µ–∑ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∫—É—Å—ã –∏ –∞—Ä–æ–º–∞—Ç—ã, —á—Ç–æ–±—ã —É —á–∏—Ç–∞—Ç–µ–ª—è —Ç–µ–∫–ª–∏ —Å–ª—é–Ω–∫–∏. 
${additionalComment ? `–£—á—Ç–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞: ${additionalComment}` : ""}
–ï—Å–ª–∏ —É –∫–ª–∏–µ–Ω—Ç–∞ –µ—Å—Ç—å –æ—Å–æ–±—ã–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –∏–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤ –µ–¥–µ, –ø–æ—Å—Ç–∞—Ä–∞–π—Å—è —É—á–µ—Å—Ç—å –∏—Ö –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –º–µ—Å—Ç –∏ –±–ª—é–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–ø—Ü–∏–∏ –¥–ª—è –≤–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Ü–µ–≤ –∏–ª–∏ –±–µ–∑–≥–ª—é—Ç–µ–Ω–æ–≤—ã–µ –±–ª—é–¥–∞). 
–î–ª—è –∫–∞–∂–¥–æ–≥–æ —É–ø–æ–º—è–Ω—É—Ç–æ–≥–æ –∑–∞–≤–µ–¥–µ–Ω–∏—è –¥–æ–±–∞–≤—å –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–Ω–æ–ø–∫—É —Å–æ —Å—Å—ã–ª–∫–æ–π: üëâ –ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ –∫–∞—Ñ–µ/—Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ

---

### 5. –°–æ–≤–µ—Ç—ã –ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫—É üß≥

–û–±—ä—è—Å–Ω–∏, –∫–∞–∫ —É–¥–æ–±–Ω–µ–µ –≤—Å–µ–≥–æ –ø–µ—Ä–µ–º–µ—â–∞—Ç—å—Å—è –ø–æ –≥–æ—Ä–æ–¥—É: —Ä–∞—Å—Å–∫–∞–∂–∏ –æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ (–º–µ—Ç—Ä–æ, —Ç—Ä–∞–º–≤–∞–∏, –∞–≤—Ç–æ–±—É—Å—ã, —Ç–∞–∫—Å–∏) –∏ –æ–± –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—è—Ö –¥–æ—Ä–æ–∂–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è, –µ—Å–ª–∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ. 
–ü–æ–¥—Å–∫–∞–∂–∏, –≤ –∫–∞–∫–∏—Ö —Å–ª—É—á–∞—è—Ö –≤—ã–≥–æ–¥–Ω–µ–µ –ø—Ä–æ–π—Ç–∏—Å—å –ø–µ—à–∫–æ–º, –∞ –≥–¥–µ –ª—É—á—à–µ –≤–∑—è—Ç—å —Ç–∞–∫—Å–∏ –∏–ª–∏ –∞—Ä–µ–Ω–¥–æ–≤–∞—Ç—å –∞–≤—Ç–æ –¥–ª—è –∫–æ–º—Ñ–æ—Ä—Ç–∞.

–ü–æ–¥–µ–ª–∏—Å—å –∏–Ω—Å–∞–π–¥–µ—Ä—Å–∫–∏–º–∏ —Å–æ–≤–µ—Ç–∞–º–∏ –æ—Ç –º–µ—Å—Ç–Ω—ã—Ö –∂–∏—Ç–µ–ª–µ–π. –ù–∞–ø—Ä–∏–º–µ—Ä: –≥–¥–µ –≤–∞—Ä—è—Ç –ª—É—á—à–∏–π –∫–æ—Ñ–µ —Å —É—Ç—Ä–∞; –≤ –∫–∞–∫–∏—Ö –∫–≤–∞—Ä—Ç–∞–ª–∞—Ö –æ—Ç–¥—ã—Ö–∞—é—Ç —Å–∞–º–∏ –≥–æ—Ä–æ–∂–∞–Ω–µ; –≤ –∫–∞–∫–∏–µ –¥–Ω–∏ –º—É–∑–µ–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã; –∫–∞–∫–æ–π —Ä—ã–Ω–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ –≤—ã—Ö–æ–¥–Ω—ã–º –∏ —Ç.–¥. 
–≠—Ç–∏ –º–µ–ª–æ—á–∏ –¥–æ–±–∞–≤—è—Ç –º–∞—Ä—à—Ä—É—Ç—É –∞—É—Ç–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç–∏.

–ú—è–≥–∫–æ –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏ –æ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –Ω—é–∞–Ω—Å–∞—Ö –∏–ª–∏ –æ–ø–∞—Å–Ω–æ—Å—Ç—è—Ö, –Ω–µ –ø—É–≥–∞—è, –∞ –∏–Ω—Ñ–æ—Ä–º–∏—Ä—É—è. –ù–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–æ–≤–µ—Ç—É–π —Å–ª–µ–¥–∏—Ç—å –∑–∞ –≤–µ—â–∞–º–∏ –≤ —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –º–µ—Å—Ç–∞—Ö (—É–ø–æ–º—è–Ω—É–≤ —ç—Ç–æ –Ω–µ–≤–∑–Ω–∞—á–∞–π) –∏–ª–∏ —É–≤–∞–∂–∞—Ç—å –º–µ—Å—Ç–Ω—ã–µ –æ–±—ã—á–∞–∏ –≤ –æ–¥–µ–∂–¥–µ –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–∏. 
–°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π —ç—Ç–æ —Ç–∞–∫—Ç–∏—á–Ω–æ –∏ –ø–æ–∑–∏—Ç–∏–≤–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –∏—Å–ø–æ—Ä—Ç–∏—Ç—å –æ–±—â–µ–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ.

–£—á—Ç–∏ —Å–æ—Å—Ç–∞–≤ –ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤: –ø—É—Ç–µ—à–µ—Å—Ç–≤—É–µ—Ç ${peopleCount} ${peopleCount === "1" ? "—á–µ–ª–æ–≤–µ–∫" : "—á–µ–ª–æ–≤–µ–∫"}. 
–ï—Å–ª–∏ –µ–¥—É—Ç —Å–µ–º—å–µ–π —Å –¥–µ—Ç—å–º–∏ –∏–ª–∏, —Å–∫–∞–∂–µ–º, –ø–æ–∂–∏–ª—ã–µ —Ç—É—Ä–∏—Å—Ç—ã, –¥–∞–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–æ–≤–µ—Ç—ã, –∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å –ø–æ–µ–∑–¥–∫—É –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–π –∏–º–µ–Ω–Ω–æ –¥–ª—è –Ω–∏—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≥–¥–µ –µ—Å—Ç—å –¥–µ—Ç—Å–∫–∏–µ –∫–æ–º–Ω–∞—Ç—ã, –ø–∞–Ω–¥—É—Å—ã, —É–¥–æ–±–Ω—ã–µ –ª–∞–≤–æ—á–∫–∏ –¥–ª—è –æ—Ç–¥—ã—Ö–∞ –∏ –ø—Ä.).

---

### 6. –ü—Ä–∏–º–µ—Ä–Ω—ã–π –±—é–¥–∂–µ—Ç üí∏

–†–∞–∑–±–µ–π –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–π –±—é–¥–∂–µ—Ç –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è –ø–æ –∫–ª—é—á–µ–≤—ã–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º: –ø—Ä–æ–∂–∏–≤–∞–Ω–∏–µ, –ø–∏—Ç–∞–Ω–∏–µ, —Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è –∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç. 
–£–∫–∞–∂–∏, —Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä–Ω–æ –±—É–¥–µ—Ç —É—Ö–æ–¥–∏—Ç—å –≤ –¥–µ–Ω—å –Ω–∞ –∫–∞–∂–¥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é. 
–ó–∞—Ç–µ–º –ø–æ–¥—Å—á–∏—Ç–∞–π –ø—Ä–∏–º–µ—Ä–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –∑–∞ –≤—Å—é –ø–æ–µ–∑–¥–∫—É –∏—Å—Ö–æ–¥—è –∏–∑ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (${startDate} ‚Äî ${endDate}) –∏ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π. 
–ü—Ä–∏–≤–µ–¥–∏ —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–∞–≥–ª—è–¥–Ω–æ, –º–æ–∂–Ω–æ –≤ –≤–∏–¥–µ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –∫—Ä–∞—Ç–∫–æ–π —Å–≤–æ–¥–∫–∏ –ø–æ –∫–∞–∂–¥–æ–º—É –ø—É–Ω–∫—Ç—É.

${budgetLevel !== "–Ω–µ —É–∫–∞–∑–∞–Ω" ? `–£—á—Ç–∏ —É–∫–∞–∑–∞–Ω–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –±—é–¥–∂–µ—Ç–∞: ${budgetLevel}.` : "–ï—Å–ª–∏ –±—é–¥–∂–µ—Ç –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –Ω–µ —É–∫–∞–∑–∞–Ω, –ø—Ä–µ–¥–ª–æ–∂–∏ —Ä–∞–∑—É–º–Ω—É—é –æ—Ü–µ–Ω–∫—É —Å—Ä–µ–¥–Ω–µ–≥–æ –±—é–¥–∂–µ—Ç–∞ –¥–ª—è —Ç–∞–∫–æ–≥–æ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ü–µ–Ω —É—Ä–æ–≤–Ω—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –æ—Ç–µ–ª–µ–π –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤)."}

–ó–∞–≤–µ—Ä—à–∏ —ç—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–º —Å–æ–≤–µ—Ç–æ–º –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞—è –∑–∞–±–æ—Ç—É –æ –≤—ã–≥–æ–¥–µ –∫–ª–∏–µ–Ω—Ç–∞. 
–ù–∞–ø—Ä–∏–º–µ—Ä: ¬´–ü—Ä–∏–æ–±—Ä–µ—Ç–∏—Ç–µ —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π City Pass ‚Äî –æ–Ω –ø–æ–∑–≤–æ–ª–∏—Ç —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å –Ω–∞ –≤—Ö–æ–¥–Ω—ã—Ö –±–∏–ª–µ—Ç–∞—Ö¬ª, –∏–ª–∏ ¬´–ë—Ä–æ–Ω–∏—Ä—É–π—Ç–µ –±–∏–ª–µ—Ç—ã –≤ –º—É–∑–µ–∏ –æ–Ω–ª–∞–π–Ω –∑–∞—Ä–∞–Ω–µ–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å–∫–∏–¥–∫—É –∏ –∏–∑–±–µ–∂–∞—Ç—å –æ—á–µ—Ä–µ–¥–µ–π¬ª. 
–≠—Ç–æ —É—Å–∏–ª–∏—Ç –æ—â—É—â–µ–Ω–∏–µ, —á—Ç–æ –º–∞—Ä—à—Ä—É—Ç –Ω–µ —Ç–æ–ª—å–∫–æ –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç, –Ω–æ –∏ –ø–æ–º–æ–≥–∞–µ—Ç —Ä–∞–∑—É–º–Ω–æ —Ç—Ä–∞—Ç–∏—Ç—å –¥–µ–Ω—å–≥–∏.

---

### 7. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ üí¨

–ó–∞–≤–µ—Ä—à–∏ –º–∞—Ä—à—Ä—É—Ç –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–º –ø—Ä–∏–∑—ã–≤–æ–º –∫ –¥–µ–π—Å—Ç–≤–∏—é. –û–±—Ä–∞—Ç–∏—Å—å –Ω–∞–ø—Ä—è–º—É—é –∫ —á–∏—Ç–∞—Ç–µ–ª—é, –ø–æ–¥—á–µ—Ä–∫–Ω—É–≤, —á—Ç–æ –≤—Å–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è –∂–¥—É—Ç –µ–≥–æ, —Å—Ç–æ–∏—Ç –ª–∏—à—å —Å–¥–µ–ª–∞—Ç—å –ø–µ—Ä–≤—ã–π —à–∞–≥. 
–°–¥–µ–ª–∞–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –∞–∫–∫–æ—Ä–¥ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º –∏ –æ–±–Ω–∞–¥–µ–∂–∏–≤–∞—é—â–∏–º: –ø–æ–æ–±–µ—â–∞–π –Ω–µ–∑–∞–±—ã–≤–∞–µ–º—ã–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥. 
–ù–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏–≥–ª–∞—Å–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å—Å—è –≤ –ø—É—Ç—å —Å–ª–æ–≤–∞–º–∏ –æ —Ç–æ–º, —á—Ç–æ —ç—Ç–æ—Ç –º–∞—Ä—à—Ä—É—Ç —Å–æ–∑–¥–∞–Ω —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –Ω–µ–≥–æ –∏ –∂–¥–µ—Ç, –∫–æ–≥–¥–∞ –º–µ—á—Ç–∞ —Å—Ç–∞–Ω–µ—Ç —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é. 
–¶–µ–ª—å –∑–∞–∫–ª—é—á–µ–Ω–∏—è ‚Äî —á—Ç–æ–±—ã —É –∫–ª–∏–µ–Ω—Ç–∞ –æ—Å—Ç–∞–ª–æ—Å—å –æ—â—É—â–µ–Ω–∏–µ —Å–∫–∞–∑–∫–∏ –Ω–∞ –ø–æ—Ä–æ–≥–µ –æ—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–∏—è –∏ –Ω–µ–ø—Ä–µ–æ–¥–æ–ª–∏–º–æ–µ –∂–µ–ª–∞–Ω–∏–µ —Å–∫–∞–∑–∞—Ç—å ¬´–î–∞!¬ª —ç—Ç–æ–º—É –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—é.

---

### 8. –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –∫–Ω–æ–ø–∫–∞–º üîó

–í –∫–æ–Ω—Ü–µ –º–∞—Ä—à—Ä—É—Ç–∞ –ø–µ—Ä–µ—á–∏—Å–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–ø–∏—Å–∫–æ–º –≤—Å–µ —É–ø–æ–º—è–Ω—É—Ç—ã–µ –º–µ—Å—Ç–∞, –∑–∞–≤–µ–¥–µ–Ω–∏—è, –æ—Ç–µ–ª–∏ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–≤ –ø–æ –∫–∞–∂–¥–æ–º—É —Å—Å—ã–ª–∫—É —Å –∫—Ä–∞—Ç–∫–æ–π —Å–ø—Ä–∞–≤–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π. 
–≠—Ç–æ –±—É–¥–µ—Ç —Å–≤–æ–µ–≥–æ —Ä–æ–¥–∞ —Ä–∞–∑–¥–µ–ª —Å –¥–µ—Ç–∞–ª—è–º–∏ –ø–æ –∫–Ω–æ–ø–∫–∞–º ¬´–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ¬ª.

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—Ç–∞ —É–∫–∞–∂–∏ –µ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –¥–∞–π –∞–∫—Ç–∏–≤–Ω—É—é —Å—Å—ã–ª–∫—É. 
–†—è–¥–æ–º –¥–æ–±–∞–≤—å 1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø—Ä–µ–≤—å—é: –Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç, –∞–¥—Ä–µ—Å –∏–ª–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã ‚Äî —Ç–æ, —á—Ç–æ –ø–æ–º–æ–∂–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å—Ä–∞–∑—É –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –æ –º–µ—Å—Ç–µ. 
–£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤—Å–µ –º–µ—Å—Ç–∞ –∏–∑ –º–∞—Ä—à—Ä—É—Ç–∞ –ø–æ–∫—Ä—ã—Ç—ã –≤ —ç—Ç–æ–º —Å–ø–∏—Å–∫–µ: –æ—Ç –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π –¥–æ –º–∞–ª–µ–Ω—å–∫–∏—Ö –∫–∞—Ñ–µ—à–µ–∫. 
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ–¥–Ω–∏–º –∫–ª–∏–∫–æ–º —É–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –ø—Ä–æ –∫–∞–∂–¥—É—é —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é.

**–§–æ—Ä–º–∞—Ç –ø—Ä–∏–º–µ—Ä–∞ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–ø–∏—Å–∫–∞:**
–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—Ç–∞ ‚Äî –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–µ—Å—Ç–∞, –ø–æ—á–µ–º—É –æ–Ω–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ –∏–ª–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ. –ê–¥—Ä–µ—Å: ... üëâ –ü–æ–¥—Ä–æ–±–Ω–µ–µ

---

### üíé –¢–æ–Ω:

–°—Ç–∏–ª—å –ø–∏—Å—å–º–∞ ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, —É–≤–µ—Ä–µ–Ω–Ω—ã–π –∏ —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ. 
–ß–∏—Ç–∞—è —Ç–µ–∫—Å—Ç, –∫–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å –∑–∞–±–æ—Ç—É, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∏–∑–º –∏ —ç–Ω—Ç—É–∑–∏–∞–∑–º –∞–≤—Ç–æ—Ä–∞ –º–∞—Ä—à—Ä—É—Ç–∞. 
–ü—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–π—Å—è –º–∞–Ω–µ—Ä—ã —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ travel-–±—Ä–µ–Ω–¥–∞: —Å–æ—á–µ—Ç–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ—Å—Ç—å —Å –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ–º. 
–≠—Ç–æ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—Å–∫–∞–∑, –∞ –Ω–µ —Å—É—Ö–æ–π —Å–ø–∏—Å–æ–∫ —Ñ–∞–∫—Ç–æ–≤. 
–í –∫–∞—á–µ—Å—Ç–≤–µ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤ –º–æ–∂–µ—à—å –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∏–ª—å –∏–∑–¥–∞–Ω–∏–π –≤—Ä–æ–¥–µ Atlas Obscura, Cond√© Nast Traveler –∏–ª–∏ –±–ª–æ–≥–∞ Discover Cars.

–í–∫—Ä–∞–ø–ª–∏–≤–∞–π —ç–ª–µ–º–µ–Ω—Ç—ã storytelling: –æ–ø–∏—à–∏ –º–µ–ª–∫–∏–µ –¥–µ—Ç–∞–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–ª–∞—é—Ç –º–µ—Å—Ç–∞ –∂–∏–≤—ã–º–∏ (–∑–≤—É–∫ –±—å—é—â–∏—Ö —á–∞—Å–æ–≤ –Ω–∞ –≥–æ—Ä–æ–¥—Å–∫–æ–π —Ä–∞—Ç—É—à–µ, –∑–∞–ø–∞—Ö —Å–≤–µ–∂–µ–≤—ã–ø–µ—á–µ–Ω–Ω–æ–≥–æ –±–∞–≥–µ—Ç–∞ –Ω–∞ —É—Ç—Ä–µ–Ω–Ω–µ–π —É–ª–æ—á–∫–µ, –∏–≥—Ä—É —Å–≤–µ—Ç–∞ –Ω–∞ –º—Ä–∞–º–æ—Ä–Ω—ã—Ö —Å—Ç–µ–Ω–∞—Ö —Å–æ–±–æ—Ä–∞ –Ω–∞ –∑–∞–∫–∞—Ç–µ). 
–¢–∞–∫–∏–µ —à—Ç—Ä–∏—Ö–∏ –ø—Ä–∏–¥–∞—é—Ç –æ–±—ä—ë–º –∏ —ç–º–æ—Ü–∏—é.

–ö–∞–∂–¥–æ–µ –º–µ—Å—Ç–æ –ø–æ–¥–∞–≤–∞–π –∫–∞–∫ –º–∞–ª–µ–Ω—å–∫–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ —Å –ª—ë–≥–∫–æ–π –Ω–æ—Ç–∫–æ–π —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω–æ—Å—Ç–∏, –±—É–¥—Ç–æ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—à—å —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –∂–µ–º—á—É–∂–∏–Ω—ã –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞. 
–ò–∑–±–µ–≥–∞–π –∫–ª–∏—à–µ, –ø–∏—à–∏ –æ–±—Ä–∞–∑–Ω–æ, –Ω–æ –∏—Å–∫—Ä–µ–Ω–Ω–µ.

–°–∞–º–æ–µ –≥–ª–∞–≤–Ω–æ–µ ‚Äî –∑–∞—Å—Ç–∞–≤—å —á–∏—Ç–∞—Ç–µ–ª—è –≤—Å–µ–º —Å–µ—Ä–¥—Ü–µ–º –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å: ¬´–î–∞, —è —Ö–æ—á—É —Ç—É–¥–∞ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.¬ª`;
};

// === –ü–æ–¥—Å—á–µ—Ç –¥–Ω–µ–π –ø–æ–µ–∑–¥–∫–∏ ===
const calculateDays = (startDate, endDate) => {
  try {
    const start = new Date(startDate);
    const end = new Date(endDate);
    const diffTime = Math.abs(end - start);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays + 1; // +1 —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –æ–±–∞ –¥–Ω—è
  } catch (e) {
    return 1;
  }
};

// === –ì–ª–∞–≤–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç ===
app.post("/api/route", async (req, res) => {
  // ‚ö° –°—Ä–∞–∑—É —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –æ—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
  let responseSent = false;
  
  const sendResponse = (success, message, plan = null) => {
    if (responseSent) return;
    responseSent = true;
    const response = { success, message };
    if (plan) {
      response.plan = plan;
    }
    res.status(200).json(response);
  };

  try {
    console.log("üì• –ù–∞—á–∞–ª–æ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞...");
    
    // –ë—ã—Å—Ç—Ä—ã–π –ø–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö
    const data = parseTildaData(req.body || {});
    console.log("üìä –†–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:", data);
    console.log("üìã –í—Å–µ –∫–ª—é—á–∏ –≤ –¥–∞–Ω–Ω—ã—Ö:", Object.keys(data));

    // –ë—ã—Å—Ç—Ä–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–æ–ª–µ–π
    const city = extractField(data, ["city", "City", "–ì–æ—Ä–æ–¥", "destination", "–≥–æ—Ä–æ–¥", "CITY"]);
    const email = extractField(data, ["email", "Email", "E-mail", "e-mail", "EMAIL"]);
    const startDate = extractField(data, ["startDate", "start-date", "start_date", "StartDate", "–¥–∞—Ç–∞_–Ω–∞—á–∞–ª–∞"]);
    const endDate = extractField(data, ["endDate", "end-date", "end_date", "EndDate", "–¥–∞—Ç–∞_–æ–∫–æ–Ω—á–∞–Ω–∏—è"]);
    const budget = extractField(data, ["budget", "Budget", "–±—é–¥–∂–µ—Ç", "BUDGET"]);
    const rawInterests = extractField(data, [
      "interests",
      "–ò–Ω—Ç–µ—Ä–µ—Å—ã",
      "interests_list",
      "INTERESTS",
      "–∏–Ω—Ç–µ—Ä–µ—Å—ã",
      "travel_interests",
      "interest",
      "Interest",
      "INTEREST",
      "–≤—ã–±–æ—Ä_–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤",
      "–≤—ã–±–æ—Ä –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤"
    ]);
    const customInterest = extractField(data, [
      "customInterest",
      "custom_interest",
      "interests_custom",
      "interest_custom",
      "–°–≤–æ–π –≤–∞—Ä–∏–∞–Ω—Ç",
      "–î—Ä—É–≥–æ–π –∏–Ω—Ç–µ—Ä–µ—Å",
      "other_interest"
    ]);
    const peopleRaw = extractField(data, [
      "people",
      "Persons",
      "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ",
      "–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ",
      "person",
      "PEOPLE",
      "travelers",
      "guests",
      "guests_count",
      "guestsCount",
      "–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ_—á–µ–ª–æ–≤–µ–∫",
      "–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–ª–æ–≤–µ–∫",
      "number_of_people",
      "numberOfPeople",
      "num_people",
      "numPeople"
    ]);
    const commentRaw = extractField(data, [
      "comment",
      "comments",
      "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π",
      "–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π",
      "notes",
      "additional_info"
    ]);

    // –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    console.log("üîç –°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª–µ–π:", {
      rawInterests: rawInterests,
      rawInterestsType: typeof rawInterests,
      customInterest: customInterest,
      peopleRaw: peopleRaw,
      peopleRawType: typeof peopleRaw,
      commentRaw: commentRaw
    });

    const interestsList = buildInterests(rawInterests, customInterest);
    const people = normalizeText(peopleRaw) || "1";
    const comment = normalizeText(commentRaw);

    console.log("üîç –ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –ø–æ–ª—è:", {
      city,
      email,
      startDate,
      endDate,
      budget,
      interests: interestsList,
      interestsCount: interestsList.length,
      people,
      comment
    });

    // ‚ö° –í–°–ï–ì–î–ê –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –±—ã—Å—Ç—Ä–æ –¥–ª—è Tilda (–¥–æ –ª—é–±—ã—Ö –¥–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π)
    // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è - –Ω–æ –≤—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–µ–º —É—Å–ø–µ—Ö–æ–º –¥–ª—è Tilda
    if (!city || !email) {
      console.warn("‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã:", { city, email, allData: data });
      sendResponse(true, "–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞! –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è.");
      return;
    }

    // ‚ö° –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –¢–∏–ª—å–¥–µ (—á—Ç–æ–±—ã –Ω–µ —Å–ª–æ–≤–∏—Ç—å timeout)
    sendResponse(true, "–ú–∞—Ä—à—Ä—É—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç!");

    // === –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ (–Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç) ===
    (async () => {
      const MAX_RETRIES = 2;
      let retryCount = 0;
      let success = false;

      while (retryCount <= MAX_RETRIES && !success) {
        try {
          if (retryCount > 0) {
            console.log(`üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ ${retryCount}/${MAX_RETRIES} –¥–ª—è ${city} (${email})...`);
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º
            await new Promise(resolve => setTimeout(resolve, 2000));
          } else {
            console.log(`üß† –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ –¥–ª—è ${city} (${email})...`);
          }

          const prompt = buildPrompt(city, startDate, endDate, budget, interestsList, people, comment);

          // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–æ 90 —Å–µ–∫—É–Ω–¥ (OpenAI –∏–Ω–æ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–µ–µ)
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 90000); // 90 —Å–µ–∫—É–Ω–¥

          const startTime = Date.now();
          const aiResponse = await fetch("https://api.openai.com/v1/chat/completions", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${process.env.OPENAI_API_KEY}`,
            },
          body: JSON.stringify({
            model: "gpt-4o-mini",
            messages: [{ role: "user", content: prompt }],
            temperature: 0.7,
            max_tokens: 4000, // –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è –ø–æ–ª–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
          }),
            signal: controller.signal,
          });

          clearTimeout(timeoutId);
          const duration = Date.now() - startTime;
          console.log(`‚è±Ô∏è OpenAI –æ—Ç–≤–µ—Ç–∏–ª –∑–∞ ${duration}ms (–ø–æ–ø—ã—Ç–∫–∞ ${retryCount + 1})`);

          if (!aiResponse.ok) {
            const err = await aiResponse.text();
            console.error(`‚ùå –û—à–∏–±–∫–∞ OpenAI (–ø–æ–ø—ã—Ç–∫–∞ ${retryCount + 1}):`, err);
            retryCount++;
            continue;
          }

          const result = await aiResponse.json();
          const choice = result.choices?.[0];
          const plan = choice?.message?.content || "–ú–∞—Ä—à—Ä—É—Ç –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å.";
          const finishReason = choice?.finish_reason || "unknown";
          const usage = result.usage || {};

          console.log("‚úÖ –ú–∞—Ä—à—Ä—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è:", city);
          console.log(`üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: ${finishReason === "stop" ? "‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é" : finishReason === "length" ? "‚ö†Ô∏è –û–ë–†–ï–ó–ê–ù –ø–æ –ª–∏–º–∏—Ç—É —Ç–æ–∫–µ–Ω–æ–≤!" : finishReason}`);
          console.log(`üìà –¢–æ–∫–µ–Ω—ã: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ ${usage.total_tokens || "N/A"} –∏–∑ ${usage.total_tokens || "N/A"} (–ø—Ä–æ–º–ø—Ç: ${usage.prompt_tokens || "N/A"}, –æ—Ç–≤–µ—Ç: ${usage.completion_tokens || "N/A"})`);
          console.log(`üìù –î–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞: ${plan.length} —Å–∏–º–≤–æ–ª–æ–≤`);
          console.log("üìÑ –ü–µ—Ä–≤—ã–µ 300 —Å–∏–º–≤–æ–ª–æ–≤:", plan.slice(0, 300) + "...");
          console.log("üìÑ –ü–æ—Å–ª–µ–¥–Ω–∏–µ 200 —Å–∏–º–≤–æ–ª–æ–≤:", "..." + plan.slice(-200));
          
          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ–±—Ä—ã–≤ –æ—Ç–≤–µ—Ç–∞
          if (finishReason === "length") {
            console.warn("‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –û—Ç–≤–µ—Ç –±—ã–ª –æ–±—Ä–µ–∑–∞–Ω –∏–∑-–∑–∞ –ª–∏–º–∏—Ç–∞ —Ç–æ–∫–µ–Ω–æ–≤!");
            console.warn("üí° –†–µ—à–µ–Ω–∏–µ: —É–≤–µ–ª–∏—á–∏—Ç—å max_tokens –∏–ª–∏ —É–ø—Ä–æ—Å—Ç–∏—Ç—å –ø—Ä–æ–º–ø—Ç");
          }

          console.log("‚úÖ –ú–ê–†–®–†–£–¢ –£–°–ü–ï–®–ù–û –°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù");

          // –û—Ç–ø—Ä–∞–≤–∫–∞ email —á–µ—Ä–µ–∑ Resend API
          try {
            const emailHtml = buildEmailTemplate(city, plan);
            await sendEmailViaResend(
              email,
              `–í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç –≤ ${city} üåç`,
              emailHtml
            );
          } catch (resendError) {
            console.error("üí• –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email —á–µ—Ä–µ–∑ Resend (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ):", resendError.message);
            // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ - –æ—à–∏–±–∫–∞ —É–∂–µ –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∞
          }
          
          success = true;
        } catch (asyncErr) {
          // –û—à–∏–±–∫–∏ –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —á–∞—Å—Ç–∏ –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ –æ—Ç–≤–µ—Ç Tilda
          if (asyncErr.name === 'AbortError') {
            const timeoutSeconds = 90;
            console.error(`‚è±Ô∏è –¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ OpenAI (${timeoutSeconds} —Å–µ–∫, –ø–æ–ø—ã—Ç–∫–∞ ${retryCount + 1}/${MAX_RETRIES + 1})`);
            console.error(`‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ú–∞—Ä—à—Ä—É—Ç –ù–ï –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${email} - –∑–∞–ø—Ä–æ—Å –ø—Ä–µ—Ä–≤–∞–Ω –ø–æ —Ç–∞–π–º–∞—É—Ç—É`);
            
            retryCount++;
            if (retryCount > MAX_RETRIES) {
              console.error(`üí• –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã. –ú–∞—Ä—à—Ä—É—Ç –¥–ª—è ${city} (${email}) –ù–ï —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω.`);
            }
          } else {
            console.error(`üí• –û—à–∏–±–∫–∞ –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ (–ø–æ–ø—ã—Ç–∫–∞ ${retryCount + 1}):`, asyncErr.message || asyncErr);
            retryCount++;
            if (retryCount > MAX_RETRIES) {
              console.error(`üí• –í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã. –ú–∞—Ä—à—Ä—É—Ç –¥–ª—è ${city} (${email}) –ù–ï —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω.`);
            }
          }
        }
      }

      if (!success) {
        console.error(`‚ùå –ò–¢–û–ì–û: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç –¥–ª—è ${city} (${email}) –ø–æ—Å–ª–µ ${MAX_RETRIES + 1} –ø–æ–ø—ã—Ç–æ–∫`);
        // TODO: –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É –∏–ª–∏ –∑–∞–ø–∏—Å—å –≤ –±–∞–∑—É –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
      }
    })();

  } catch (err) {
    console.error("üí• –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–∞:", err);
    // –î–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –æ—Ç–≤–µ—á–∞–µ–º —É—Å–ø–µ—Ö–æ–º –¥–ª—è Tilda
    if (!responseSent) {
      sendResponse(true, "–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞! –ú—ã –æ–±—Ä–∞–±–æ—Ç–∞–µ–º –µ—ë –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.");
    }
  }
});

// === –§—É–Ω–∫—Ü–∏—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è HTML-—à–∞–±–ª–æ–Ω–∞ –ø–∏—Å—å–º–∞ ===
const buildEmailTemplate = (city, plan) => {
  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ç–µ–∫—Å—Ç –º–∞—Ä—à—Ä—É—Ç–∞ –≤ HTML —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
  let formattedPlan = plan
    // –°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –¥–æ –∑–∞–º–µ–Ω—ã \n –Ω–∞ <br>)
    .replace(/### (.*?)(\n|$)/g, '<h3 style="margin-top: 28px; margin-bottom: 16px; color: #2c3e50; font-size: 20px; font-weight: 600; padding-top: 8px; border-top: 2px solid #f0f0f0;">$1</h3>')
    .replace(/## (.*?)(\n|$)/g, '<h2 style="margin-top: 32px; margin-bottom: 16px; color: #1a1a1a; font-size: 24px; font-weight: 700; padding-bottom: 8px; border-bottom: 2px solid #e0e0e0;">$1</h2>')
    // –≠–º–æ–¥–∑–∏ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤
    .replace(/‚Äì /g, '<span style="color: #667eea; margin-right: 8px;">‚Ä¢</span> ')
    .replace(/^(\d+\.\s)/gm, '<span style="color: #667eea; font-weight: 600; margin-right: 8px;">$1</span>')
    // –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–º, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª —Å –∫—É—Ä—Å–∏–≤–æ–º)
    .replace(/\*\*(.*?)\*\*/g, '<strong style="color: #1a1a1a; font-weight: 600;">$1</strong>')
    // –ö—É—Ä—Å–∏–≤ (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ—Å–ª–µ –∂–∏—Ä–Ω–æ–≥–æ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤)
    .replace(/([^*]|^)\*([^*]+?)\*([^*]|$)/g, '$1<em style="color: #555555; font-style: italic;">$2</em>$3')
    // –ü–∞—Ä–∞–≥—Ä–∞—Ñ—ã —Å –æ—Ç—Å—Ç—É–ø–∞–º–∏
    .split('\n')
    .map(line => {
      const trimmed = line.trim();
      // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ (–±—É–¥—É—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –æ—Ç–¥–µ–ª—å–Ω–æ)
      if (!trimmed) return '<p style="margin: 8px 0;"></p>';
      // –ï—Å–ª–∏ —ç—Ç–æ —É–∂–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
      if (trimmed.startsWith('<h2') || trimmed.startsWith('<h3')) return trimmed;
      // –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç —Å –æ—Ç—Å—Ç—É–ø–æ–º
      return `<p style="margin: 12px 0; line-height: 1.8; color: #333333;">${trimmed}</p>`;
    })
    .join('');

  return `
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–í–∞—à –º–∞—Ä—à—Ä—É—Ç –≤ ${city}</title>
</head>
<body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: #f5f5f5; line-height: 1.6;">
  <table role="presentation" width="100%" cellpadding="0" cellspacing="0" style="background-color: #f5f5f5; padding: 40px 20px;">
    <tr>
      <td align="center">
        <table role="presentation" width="600" cellpadding="0" cellspacing="0" style="background-color: #ffffff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); max-width: 600px; margin: 0 auto;">
          <!-- Header -->
          <tr>
            <td style="padding: 40px 40px 20px 40px; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px 12px 0 0;">
              <h1 style="margin: 0; color: #ffffff; font-size: 28px; font-weight: 700;">
                üåç –í–∞—à –º–∞—Ä—à—Ä—É—Ç –≤ ${city}
              </h1>
            </td>
          </tr>
          
          <!-- Content -->
          <tr>
            <td style="padding: 40px;">
              <div style="color: #333333; font-size: 16px; line-height: 1.8;">
                ${formattedPlan}
              </div>
            </td>
          </tr>
          
          <!-- Footer -->
          <tr>
            <td style="padding: 30px 40px 40px 40px; text-align: center; border-top: 1px solid #e0e0e0; background-color: #fafafa; border-radius: 0 0 12px 12px;">
              <p style="margin: 0 0 12px 0; color: #666666; font-size: 16px; font-style: italic;">
                –° –ª—é–±–æ–≤—å—é, –∫–æ–º–∞–Ω–¥–∞ Airravel ‚úàÔ∏è
              </p>
              <p style="margin: 0; color: #999999; font-size: 14px;">
                <a href="https://airravel.com" style="color: #667eea; text-decoration: none; font-weight: 500;">airravel.com</a>
              </p>
            </td>
          </tr>
        </table>
      </td>
    </tr>
  </table>
</body>
</html>
  `.trim();
};

// === –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ email —á–µ—Ä–µ–∑ Resend API ===
const sendEmailViaResend = async (email, subject, htmlContent) => {
  if (!process.env.RESEND_API_KEY) {
    console.warn("‚ö†Ô∏è RESEND_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É email —á–µ—Ä–µ–∑ Resend");
    return;
  }

  try {
    const response = await fetch("https://api.resend.com/emails", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${process.env.RESEND_API_KEY}`,
      },
      body: JSON.stringify({
        from: "AI Trip Planner <info@airravel.com>",
        to: [email],
        subject: subject,
        html: htmlContent,
      }),
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error("‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email —á–µ—Ä–µ–∑ Resend:", {
        status: response.status,
        error: errorText,
      });
      return;
    }

    const result = await response.json();
    console.log("‚úÖ Email –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —á–µ—Ä–µ–∑ Resend:", { email, id: result.id });
  } catch (err) {
    console.error("üí• –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ email —á–µ—Ä–µ–∑ Resend:", err.message);
    // –ù–µ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–∞–ª—å—à–µ - –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
  }
};

// === –¢–µ—Å—Ç–æ–≤—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã ===
app.get("/", (req, res) =>
  res.json({ status: "OK", endpoint: "/api/route", time: new Date().toISOString() })
);
app.get("/health", (req, res) =>
  res.json({ status: "healthy", uptime: process.uptime(), time: new Date().toISOString() })
);

// === –ó–∞–ø—É—Å–∫ ===
app.listen(PORT, "0.0.0.0", () => {
  console.log(`
üöÄ AI Trip Planner READY
üìç PORT: ${PORT}
üîë OpenAI: ${process.env.OPENAI_API_KEY ? "‚úÖ Loaded" : "‚ùå Missing"}
üïí Started: ${new Date().toISOString()}
`);
});
